name: Deploy AuroraVoyages to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸ› ï¸ Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: ğŸ“¦ Install Backend Dependencies
      run: |
        cd backend
        npm install

    - name: ğŸš€ Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    - name: ğŸ” Setup SSH Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“¡ Deploy to Azure VM
      run: |
        scp -r ./frontend/build/ ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:/var/www/html/aurora/frontend/
        scp -r ./backend ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:/var/www/html/aurora/
        ssh ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} << 'EOF'
          cd /var/www/html/aurora/backend
          npm install
          pm2 restart all || pm2 start npm --name aurora-backend -- start
          sudo systemctl restart apache2
        EOF

    - name: âœ… Confirm Deployment
      run: echo "Deployment to Aurora VM complete!"
